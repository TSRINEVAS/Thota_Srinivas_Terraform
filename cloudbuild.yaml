options:
  logging: CLOUD_LOGGING_ONLY

serviceAccount: '932539802604-compute@developer.gserviceaccount.com'

availableSecrets:
  secretManager:
    - versionName: projects/vaulted-epigram-457004-c6/secrets/service-account-key/versions/latest
      env: GOOGLE_CREDENTIALS

steps:
  - name: hashicorp/terraform:1.5.7
    id: Terraform Init
    entrypoint: sh
    secretEnv: ['GOOGLE_CREDENTIALS']
    args:
      - -c
      - |
        echo "$GOOGLE_CREDENTIALS" > key.json
        terraform init \
          -backend-config="bucket=thotaterra" \
          -backend-config="prefix=terraform/state" \
          -backend-config="credentials=key.json"

  - name: hashicorp/terraform:1.5.7
    id: Terraform Plan
    entrypoint: sh
    secretEnv: ['GOOGLE_CREDENTIALS']
    args:
      - -c
      - |
        echo "$GOOGLE_CREDENTIALS" > key.json
        terraform plan -var-file="terraform.tfvars" -var="credentials_file=key.json"
